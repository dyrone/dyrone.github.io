<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Git pack and index - dyrone&#39;s blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Git pack and index" />
<meta property="og:description" content="`This article is written in Chinese." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dyrone.github.io/posts/git-midx/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-07T14:44:25+08:00" />
<meta property="article:modified_time" content="2022-03-07T14:44:25+08:00" />


		<meta itemprop="name" content="Git pack and index">
<meta itemprop="description" content="`This article is written in Chinese."><meta itemprop="datePublished" content="2022-03-07T14:44:25+08:00" />
<meta itemprop="dateModified" content="2022-03-07T14:44:25+08:00" />
<meta itemprop="wordCount" content="778">
<meta itemprop="keywords" content="git,chinese," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Git pack and index"/>
<meta name="twitter:description" content="`This article is written in Chinese."/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="æ»• é¾™" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/placeholder.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">æ»• é¾™</div>
					<div class="logo__tagline">Teng Long</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Git pack and index</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2022-03-07T14:44:25&#43;08:00">2022-03-07</time></div></div>
		</header>
		<div class="content post__content clearfix">
			<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>`This article is written in Chinese. `</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>About pack and index file in git.</p>
</div>
<div class="sect1">
<h2 id="_1_git_packfile_ä»‹ç»">1. git packfile ä»‹ç»</h2>
<div class="sectionbody">
<div class="paragraph">
<p>é¦–å…ˆæˆ‘ä»¬è¦äº†è§£çš„äº‹ï¼Œ Gitä¸­ä½¿ç”¨ <code>å¯¹è±¡</code> æ¥ä¿å­˜æˆ‘ä»¬çš„ä¿®æ”¹å†…å®¹å’Œå†å²,å…³äºGitå¯¹è±¡çš„åˆ†ç±», ç›®å‰æœ‰ä¸¤ç§ä¸åŒçš„ <code>åˆ†æ³•</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>å°†Gitå¯¹è±¡åˆ†ç±»ä¸º <strong>4</strong> ä¸ª, è¿™ä¸ªä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„åˆ†æ³•, å…¶ä¸­åŒ…å« blob/tree/commit/tag.</p>
</li>
<li>
<p>åœ¨ç¬¬1ç§åˆ†ç±»çš„åŸºç¡€ä¸Š, å°† packfile (ä½¿ç”¨zlibæ¥å¯¹å…¶ä»–å¯¹è±¡å‹ç¼©åçš„æ–‡ä»¶) ä½œä¸ºç¬¬ <strong>5</strong> ç§å¯¹è±¡(wikiä¸­çš„packfileçš„è¯´æ˜).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>å¦‚æœå¸Œæœ›äº†è§£Gitçš„4ç§åŸºæœ¬å¯¹è±¡å’Œä¸ºä»€ä¹ˆä»–ä»¬åŸºäº <code>å¿«ç…§</code> çš„å­˜å‚¨ç­–ç•¥ï¼Œæˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡ <a href="https://mp.weixin.qq.com/s/UTETcreecYfotJzlR1fAkw">ã€Š15åˆ†é’Ÿäº†è§£Gitå¯¹è±¡ã€‹</a>ã€‚</p>
</div>
<div class="paragraph">
<p>ç°åœ¨æˆ‘ä»¬å›è¿‡æ¥ç»§ç»­çœ‹packfile.</p>
</div>
<div class="paragraph">
<p>Gité€šè¿‡blob/tree/commit/tagæ¥å­˜å‚¨å¯¹è±¡, è¿™äº›å¯¹è±¡æœ¬è´¨ä¸Šéƒ½æ˜¯gitä»“åº“ä¸­çš„å­˜å‚¨çš„æ–‡ä»¶ã€‚ å¦‚æœå¯¹è±¡æ–‡ä»¶è¾ƒå°‘ï¼Œ ä»“åº“çš„æ€§èƒ½è¿˜å¯ä»¥æ¥å—ã€‚ ä½†éšç€ä»“åº“æäº¤è¶Šæ¥è¶Šå¤šï¼Œ è¿™äº›æ¾æ•£å­˜å‚¨ï¼ˆæ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼‰çš„å¯¹è±¡æ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤šï¼Œå¹¶ä¸”å ç”¨çš„ä½“ç§¯ä¼šè¶Šæ¥è¶Šå¤§ï¼ˆå­˜å‚¨å¿«ç…§è€Œéå·®å¼‚ï¼‰, ä¼šå¯¼è‡´ä»“åº“æ€§èƒ½éšä¹‹ä¸‹é™ã€‚æ‰€ä»¥Gitéœ€è¦ä¸€ç§èšåˆçš„å­˜å‚¨æ–¹å¼ï¼Œè¯•å›¾å°†è¿™äº›æ¾æ•£çš„æ–‡ä»¶ç»„ç»‡èµ·æ¥ï¼Œ ä»è€Œè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ è¿™å°±æ˜¯`packfile`çš„ç”±æ¥ã€‚</p>
</div>
<div class="paragraph">
<p>Packfileä¸­é™¤äº†å¯ä»¥åŒ…å«ä¸Šé¢æåˆ°çš„blob/tree/commit/tagå¯¹è±¡å¤–, è¿˜å¯ä»¥æ”¯æŒå­˜å‚¨ <code>delta</code> å¯¹è±¡ã€‚deltaå¯¹è±¡æ˜¯ä¸€ç§æ›´åŠ é«˜æ•ˆçš„å­˜å‚¨æ–¹å¼(ä½†æ˜¯å¯èƒ½é¢å¤–æ¶ˆè€—è®¡ç®—èµ„æº), å®ƒå¯ä»¥å®ç°åœ¨packä¸­å­˜å‚¨å¯¹è±¡ä¹‹é—´çš„å·®å¼‚, è€Œéé‡æ–°å­˜å‚¨æ•´ä¸ªå¯¹è±¡, è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†packfileæ–‡ä»¶çš„ä½“ç§¯ã€‚ï¼ˆä¾‹å¦‚,å­˜åœ¨ä¸€ä¸ª100Mçš„æ–‡æœ¬æ–‡(baseå¯¹è±¡),ä¿®æ”¹ä¿®æ”¹10æ¬¡,ä½†æ˜¯æ¯æ¬¡æ”¹åŠ¨éƒ½åªæ–°å¢äº†ä¸€è¡Œ, é‚£åŸºäºblobçš„deltaçš„å­˜å‚¨æ–¹å¼å¯ä»¥èŠ‚çº¦1000Mçš„å­˜å‚¨ç©ºé—´ã€‚ï¼‰</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_packçš„æ–‡ä»¶çš„å­˜å‚¨æ ¼å¼">2. packçš„æ–‡ä»¶çš„å­˜å‚¨æ ¼å¼</h2>
<div class="sectionbody">
<div class="paragraph">
<p>å…³äºpackfileçš„å­˜å‚¨æ ¼å¼, git-scmä¸­æœ‰æ¯”è¾ƒè¯¦ç»†çš„æ–‡æ¡£ <a href="https://git-scm.com/docs/pack-format#_pack_pack_files_have_the_following_format">è‹±æ–‡ä»‹ç»</a>, æˆ‘åœ¨è¿™é‡Œç”»äº†ä¸€ä¸ªå›¾ï¼Œå…¶ä¸­ä¸»è¦åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š æ–‡ä»¶å¤´ï¼Œ åŒ…å«çš„å¯¹è±¡çš„å­˜å‚¨å†…å®¹å’Œæ–‡ä»¶å°¾ï¼Œ æˆ‘ä»¬ä¾æ¬¡æ¥çœ‹ä¸‹å®ƒä»¬çš„ç»“æ„:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../images/packfile.png" alt="Packfile Format" width="512" height="512"/></span></p>
</div>
<div class="sect2">
<h3 id="_2_1_header_å’Œ_trailer">2.1 HEADER å’Œ TRAILER</h3>
<div class="paragraph">
<p>HEADERç”±ä¸‰éƒ¨åˆ†æ„æˆã€‚</p>
</div>
<div class="sect3">
<h4 id="_2_1_1_packfileæ–‡ä»¶ç­¾å">2.1.1 packfileæ–‡ä»¶ç­¾å</h4>
<div class="paragraph">
<p>ç”¨æ¥å­˜æ”¾&#34;PACK&#34;çš„å­—é¢é‡ï¼ˆ50 41 43 4bï¼‰ï¼Œå…±4 bytesã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_1_2_packfileç‰ˆæœ¬">2.1.2 packfileç‰ˆæœ¬</h4>
<div class="paragraph">
<p>ç›®å‰é»˜è®¤é‡‡ç”¨v2ç‰ˆæœ¬(00 00 00 02)ï¼Œå…±4 bytes</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_1_3_packfileä¸­çš„å¯¹è±¡æ•°é‡">2.1.3 packfileä¸­çš„å¯¹è±¡æ•°é‡</h4>
<div class="paragraph">
<p>å¯¹è±¡æ•°é‡: &lt;num_objects&gt;ï¼Œå…±4 bytesã€‚</p>
</div>
<div class="paragraph">
<p>TRAILER packæ–‡ä»¶çš„checksumï¼ˆ20 bytesï¼‰ã€‚</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_dataéƒ¨åˆ†">2.2 DATAéƒ¨åˆ†</h3>
<div class="paragraph">
<p>æŒ‰ç…§pack-orderå­˜å‚¨å„ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­édeltaå¯¹è±¡å’Œdeltaå¯¹è±¡çš„å­˜å‚¨æ ¼å¼æœ‰æ‰€å·®å¼‚ã€‚</p>
</div>
<div class="sect3">
<h4 id="_2_2_1_size_data_encoding">2.2.1 size data encoding</h4>
<div class="paragraph">
<p>è¿™éƒ¨åˆ†æ•°æ®é‡‡ç”¨&lt;size-data-encoding&gt;çš„æ–¹å¼å­˜å‚¨ï¼Œbigendianï¼Œæ¯ä¸€ä¸ªsize chunkä¸º 1byte, ç¬¬ä¸€ä¸ªchunkæ¯”è¾ƒç‰¹æ®Šè¿˜è´Ÿè´£ä¿å­˜å¯¹è±¡çš„ç±»å‹ä¿¡æ¯:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">size-data-encoding head:</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;MSB&gt;       &lt;type&gt;     &lt;size-tail&gt;
|&lt;-1 bit-&gt;|&lt;-- 3 bits--&gt;|&lt;---4 bits---&gt;|</pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">MSB (Most Significant Bit):</div>
<div class="literalblock">
<div class="content">
<pre>if 0 : ç»“æŸä½çš„size data encoding
if 1 : ç»§ç»­æ‰«æä¸‹ä¸€ä¸ªå­—èŠ‚çš„size data encoding</pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">object type:</div>
<div class="literalblock">
<div class="content">
<pre>OBJ_COMMIT (001)
OBJ_TREE (010)
OBJ_BLOB (011)
OBJ_TAG (100)
OBJ_OFS_DELTA (110)
OBJ_REF_DELTA (111)</pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">size-tail:</div>
<div class="literalblock">
<div class="content">
<pre>ç”¨äºä¿å­˜sizeçš„å4ä½</pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">size-data-chunk-mid(end)(optional)</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;MSB&gt;             &lt;size-mid&gt;
|&lt;-1 bit-&gt;|&lt;---------- 7 bits----------&gt;|</pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">æ•…æŒ‰ç…§å›¾ä¸­ç¬¬ä¸€ä¸ªå¯¹è±¡(å‡å®šä¸ºédeltaå¯¹è±¡)çš„sizeä¸ºï¼š</div>
<div class="literalblock">
<div class="content">
<pre>size = (C &lt;&lt; 11) | (B &lt;&lt; 7) | (C &lt;&lt; 4)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>å¾—çŸ¥äº†å¯¹è±¡çš„sizeä¹‹åï¼Œ ä¾¿å¯ä»¥ç»§ç»­è·å–æ•°æ®çš„dataäº†ã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_2_2_deltaå¯¹è±¡å­˜å‚¨ä¸Šçš„å·®åˆ«">2.2.2 deltaå¯¹è±¡å­˜å‚¨ä¸Šçš„å·®åˆ«</h4>
<div class="sidebarblock">
<div class="content">
<div class="title">deltaå¯¹è±¡è¦ç¨å¾®å¤æ‚ä¸€äº›ï¼Œ packfileä¸­æ”¯æŒå­˜å‚¨ä¸¤ç§ç±»å‹çš„deltaå¯¹è±¡:</div>
<div class="literalblock">
<div class="content">
<pre>OBJ_REF_DELTAï¼š å­˜å‚¨base object nameï¼ˆ20 bytesï¼‰, delta objectå¯èƒ½ä¸base objectä¸åœ¨åŒä¸€ä¸ªpackä¸­æ—¶
OBJ_OFS_DELTAï¼š å­˜å‚¨delta objectç›¸å¯¹base objectçš„ offset åç§»é‡ï¼Œ ä»è€Œå¯ä»¥å¾—çŸ¥base objectçš„å­˜å‚¨ä½ç½®ã€‚delta objectä¸base objectå¿…å®šåœ¨åŒä¸€ä¸ªpackä¸­ã€‚</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>deltaæ•°æ®æ˜¯ä»base objectåŸºç¡€ä¸Šé‡æ–°æ„é€ å¯¹è±¡çš„ä¸€å¥—æŒ‡ä»¤åºåˆ—ï¼ˆinstrumentsï¼‰ã€‚å¦‚æœbase objectåŒæ ·æ˜¯ä¸€ä¸ªdeltaï¼Œåˆ™å¿…é¡»é¦–å…ˆå°†å…¶è¿˜åŸä¸ºæ™®é€šå¯¹è±¡ï¼Œ å°±è¿™æ ·é€’å½’å¾€å¤ç›´åˆ°base objectä¸æ˜¯deltaå¯¹è±¡ä¸ºæ­¢ï¼Œ è¿™æ ·å°±è¿˜åŸå‡ºäº†å®Œæ•´çš„å¯¹è±¡ã€‚ç›®å‰æ”¯æŒçš„æŒ‡ä»¤æœ‰ä¸¤ä¸ª:ä¸€ä¸ªç”¨äºä»æºå¯¹è±¡å¤åˆ¶å­—èŠ‚èŒƒå›´ï¼Œå¦ä¸€ä¸ªç”¨äºæ’å…¥åµŒå…¥åˆ°æŒ‡ä»¤æœ¬èº«çš„æ–°æ•°æ®ã€‚</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>ä¹Ÿè®¸ä½ ä¼šé—®ï¼Œ è¿™ç¯‡æ–‡ç« ç©¶ç«Ÿè¦ä»‹ç»ä»€ä¹ˆï¼Ÿ</p>
</div>
<div class="paragraph">
<p>æ˜¯çš„ï¼Œè¿™ç¯‡æ–‡ç« å¸Œæœ›è®²è¿°git multiple packs indexçš„å†…å®¹ï¼Œæ‰€ä»¥ç›®å‰ä¸ºæ­¢ï¼Œ æˆ‘è¯´äº†å¾ˆå¤špackçš„å†…å®¹ï¼Œè¿™ç‚¹ä¸Šä¼¼ä¹æ— æ³•å·æ‡’ã€‚ ä½†ä¹Ÿè®¸æˆ‘è¯¥å°±æ­¤æ‰“ä½ï¼Œ å› ä¸ºDeltaçš„å­˜å‚¨å’Œè®¡ç®—ç‰µæ‰¯å‡ºå¦å¤–éå¸¸å¤šçš„å†…å®¹ï¼Œ å†ç”¨å¦ä¸€ç¯‡å•ç‹¬çš„BLOGä¸­è®²è§£ï¼ˆåŒæ—¶æˆ‘ä¹Ÿéœ€è¦å†ä¸€æ¬¡ç¡®è®¤å¾ˆå¤šå…¶ä¸­çš„ç»†èŠ‚ï¼‰ï¼Œ å½“ç„¶ä¹Ÿå¯ä»¥å…ˆå‚è€ƒ <a href="https://git-scm.com/docs/pack-format#_deltified_representation">git-scmæ–‡æ¡£</a> çš„å†…å®¹å…ˆç¹ä¸ºå¿«ã€‚</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_pack_index">3. pack-index</h2>
<div class="sectionbody">
<div class="paragraph">
<p>pack-indexåœ¨åœ¨æ–‡ä»¶å‘½åä¸Šï¼Œ å®ƒçš„åå­—æ˜¯`pack-name.idx`ï¼Œ å…¶ä¸­pack-nameæ˜¯packæ–‡ä»¶çš„åå­—, nameæ˜¯packæ–‡ä»¶checksumçš„SHA1ç¼–ç  ã€‚packæ–‡ä»¶åˆ™æ˜¯`pack-name.pack`å‘½åï¼Œé€šè¿‡æ–‡ä»¶åå°†indexå’Œpackæ–‡ä»¶è”ç³»åœ¨ä¸€èµ·ï¼Œ å¹¶å¯é€šè¿‡æ–‡ä»¶åå’Œå®é™…å­˜å‚¨çš„checksumè¿›è¡Œæ ¡éªŒã€‚</p>
</div>
<div class="paragraph">
<p>ä¸‹é¢æ˜¯æˆ‘æœ¬åœ°æµ‹è¯•ä»“åº“ä¸­çš„ä¸€ä¸ªä¸€ä¸ªæ ·ä¾‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[tenglong.tl@code-infra-dev-cbj.ea134 /home/tenglong.tl/test/pack-test.git/.git/objects/pack]
$ll
total 24
-r--r--r-- 1 tenglong.tl users 1156 Feb 18 16:17 pack-5861a641a77e5fa0637b6426615c834424012140.idx
-r--r--r-- 1 tenglong.tl users  262 Feb 18 16:17 pack-5861a641a77e5fa0637b6426615c834424012140.pack
-r--r--r-- 1 tenglong.tl users 1156 Feb 16 14:52 pack-bbe47ea26bb124a49bbb93aaebf067c7971843c4.idx
-r--r--r-- 1 tenglong.tl users  210 Feb 16 14:52 pack-bbe47ea26bb124a49bbb93aaebf067c7971843c4.pack
-r--r--r-- 1 tenglong.tl users 1156 Feb 18 16:17 pack-f81aa0c5662aa3f1b084f63f80d7417b5f41b74d.idx
-r--r--r-- 1 tenglong.tl users  293 Feb 18 16:17 pack-f81aa0c5662aa3f1b084f63f80d7417b5f41b74d.pack</code></pre>
</div>
</div>
<div class="paragraph">
<p>packç´¢å¼•æ–‡ä»¶çš„çš„ä½œç”¨æ˜¯ï¼Œ æ ¹æ®objectåç§°åˆ›å»ºåˆ°packæ–‡ä»¶ä¸­å­˜å‚¨ä½ç½®ï¼ˆoffsetï¼‰çš„æ˜ å°„ï¼Œ åœ¨æ—¶é—´å¤æ‚åº¦ä¸ºO(logN)çš„æƒ…å†µä¸‹ï¼Œå¿«é€Ÿè·å–å¯¹è±¡çš„å­˜å‚¨å†…å®¹ã€‚</p>
</div>
<div class="sect2">
<h3 id="_3_1_pack_indexæ–‡ä»¶æ ¼å¼">3.1 pack-indexæ–‡ä»¶æ ¼å¼</h3>
<div class="paragraph">
<p>pack indexæ–‡ä»¶å­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬ï¼Œ ç›®å‰é»˜è®¤æŒ‰ç…§v2è¿›è¡Œå­˜å‚¨ï¼Œæˆ‘ä»¬ä¹Ÿå°†é’ˆå¯¹v2è¿›è¡Œä»‹ç».</p>
</div>
</div>
<div class="sect2">
<h3 id="_pack_index_v2æ–‡ä»¶æ ¼å¼">pack-index v2æ–‡ä»¶æ ¼å¼</h3>
<div class="paragraph">
<p><span class="image"><img src="../../images/packindex.png" alt="Packfile Format" width="512" height="512"/></span></p>
</div>
<div class="paragraph">
<p>v2çš„æ–‡ä»¶å­˜å‚¨æ ¼å¼åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
</div>
<div class="sect3">
<h4 id="_3_1_1_header">3.1.1 HEADER</h4>
<div class="ulist">
<ul>
<li>
<p>v2ç‰ˆæœ¬idxæ–‡ä»¶çš„ç­¾åä¿¡æ¯ï¼š &#34;\377tOc&#34; å  4 bytes</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>gitä½¿ç”¨äº†è¿™æ ·ä¸€ä¸ªé­”æ³•å€¼ æ¥è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªv2 ç‰ˆæœ¬çš„pack-indexæ–‡ä»¶ï¼Œå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ª8è¿›åˆ¶è¡¨ç¤ºï¼Œå¦‚æœç”¨10è¿›åˆ¶åˆ™ä¸º255tOcã€‚ å› ä¸ºv1ç‰ˆæœ¬æ˜¯ç›´æ¥ä»fanoutåŒºå¼€å§‹å­˜å‚¨
&gt;ï¼ˆfanoutåé¢ä¼šä»‹ç»ï¼‰ï¼Œ è€Œè¯¥é­”æ³•å€¼æ˜æ˜¾æ˜¯ä¸€ä¸ªéæ³•çš„fanout[0]çš„å–å€¼ã€‚ è¿™æ ·å°±å¯ä»¥é˜²æ­¢ä½ç‰ˆæœ¬çš„gitï¼Œ é”™è¯¯çš„å¤„ç†v2ç‰ˆæœ¬çš„pack idxæ–‡ä»¶ã€‚</p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>idxæ–‡ä»¶çš„ç‰ˆæœ¬å·ï¼š ç›®å‰é»˜è®¤ä¸º2ï¼Œ å 4 bytes</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_3_1_2_fanout">3.1.2 FANOUT</h4>
<div class="paragraph">
<p>FANOUTæ‰‡åŒºè¡¨ç”¨æ¥å­˜å‚¨æ¯ä¸ªobjectçš„å­˜å‚¨ä½ç½®ï¼Œ æ¯ä¸ªæ‰‡åŒºå ç”¨çš„ç©ºé—´æ˜¯4ä¸ªå­—èŠ‚ã€‚ æ ¹æ®objectnameçš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¿›è¡Œåˆ’åˆ†æ‰‡åŒºï¼Œå› ä¸ºæœ€å¤šåªæœ‰0~255ï¼ˆ00-ffï¼‰ä¸ªobjectï¼Œæ‰€ä»¥fanoutçš„é•¿åº¦ä¸º256*4=1024ä¸ªå­—èŠ‚ã€‚</p>
</div>
<div class="paragraph">
<p>æ‰‡åŒºçš„ç´¢å¼•ä»0å¼€å§‹ï¼Œ å³fanout[0]è¡¨ç¤ºæ‰‡åŒº0çš„å¼€å§‹ä½ç½®ï¼Œ fanout[1]è¡¨ç¤ºæ‰‡åŒº1çš„å¼€å§‹ä½ç½®ï¼Œ fanout[255]è¡¨ç¤ºæ‰‡åŒº255çš„å¼€å§‹ä½ç½®ã€‚ fanout[0]ä»£è¡¨äº†objectnameç¬¬ä¸€ä¸ªå­—èŠ‚çš„å€¼ä¸º <code>00</code> çš„objectçš„æ•°é‡ï¼Œ fanout[1]ä»£è¡¨äº†objectnameç¬¬ä¸€ä¸ªå­—èŠ‚çš„å€¼ä¸º <code>00~01</code> çš„objectçš„å­˜å‚¨æ•°é‡ï¼Œ æ‰€ä»¥è¿›è€Œfanout[255]ä»£è¡¨äº†è¯¥indexä¸­ç´¢å¼•å¯¹è±¡çš„æ€»æ•°ã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_1_3_objectname_list">3.1.3 objectname_list</h4>
<div class="paragraph">
<p>objectname_listéƒ¨åˆ†è´Ÿè´£å­˜å‚¨æ‰€æœ‰çš„å¯¹è±¡çš„åç§°åˆ—è¡¨ï¼Œ å­˜å‚¨é¡ºåºä¸ºå­—å…¸é¡ºåºã€‚ è¿™æ ·çš„å­˜å‚¨çš„ç›®çš„æ˜¯å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼å¿«é€Ÿå®šä½åˆ°å¯¹è±¡çš„åœ¨objectname_listä¸­çš„çš„positionã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_1_4_crcæ ¡éªŒåŒº">3.1.4 CRCæ ¡éªŒåŒº</h4>
<div class="paragraph">
<p>å­˜å‚¨CRCä¿¡æ¯çš„å¥½å¤„æ˜¯ï¼Œå½“æˆ‘ä»¬ç›´æ¥ä»ä¸€ä¸ªpackä¸­copyæ•°æ®åˆ°å¦ä¸€ä¸ªpackä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°‘æ ¡éªŒä¸€æ¬¡CRCç›´æ¥copyã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_1_5_offsetsåŒº">3.1.5 offsetsåŒº</h4>
<div class="paragraph">
<p>offsetsåŒºå­˜å‚¨äº†objectå¯¹åº”åœ¨packä¸­çš„å­˜å‚¨åç§»é‡ï¼Œ å…¶é¡ºåºä¸objectname_listä¸­çš„é¡ºåºä¸€è‡´ã€‚ æ•…ï¼Œåªè¦åœ¨objectname_listä¸­æŸ¥è¯¢åˆ°äº†æŸä¸ªå¯¹è±¡åœ¨åˆ—è¡¨ä¸­çš„positonï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥é€šè¿‡offsets[positon]è·å–å¯¹è±¡åœ¨packä¸­çš„å­˜å‚¨åç§»é‡ã€‚</p>
</div>
<div class="paragraph">
<p>æ¯ä¸€ä¸ªoffsetå ç”¨4 bytesï¼Œ å­˜å‚¨çš„æ ¼å¼ä¸ºï¼š</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>   &lt;MSB&gt;             &lt;offset&gt;
|&lt;-1 bit-&gt;|&lt;---------- 31 bits----------&gt;|</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>MSBè´Ÿè´£æ ‡è®°è¯¥offsetæ˜¯å¦æ˜¯ä¸€ä¸ªlarge offsetï¼Œè¿™æ˜¯å› ä¸ºåœ¨packä¸­offsetçš„å€¼æ˜¯æœ‰å¯èƒ½å¤§äº2^31çš„ï¼Œ æ‰€ä»¥å¯ä»¥é€šè¿‡MSBæ¥åˆ¤æ–­æ˜¯å¦æ˜¯large offsetã€‚</p>
</div>
<div class="paragraph">
<p>å³ï¼Œ å½“MSBä¸º1ï¼Œ é‚£ä¹ˆä»£è¡¨è¯¥offsetæŒ‰ç…§large offsetçš„æ ¼å¼å¤„ç†ï¼Œ offsetæŒ‡å‘çš„æ˜¯åœ¨å½“å‰indexæ–‡ä»¶ä¸­large offsetsåŒºåç§»é‡ï¼Œæ”¹åç§»é‡æ‰€ä»£è¡¨çš„å€¼ä¸ºå®é™…æŒ‡å‘packä¸­çš„offsetã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_1_6_large_offsetsoptional">3.1.6 large offsets(optional)</h4>
<div class="ulist">
<ul>
<li>
<p>åªæœ‰å½“å¯¹åº”épackæ–‡ä»¶ &gt; 2Gæ—¶ï¼Œ indexæ–‡ä»¶ä¸­æ‰ä¼šç”Ÿæˆlarge offsetsï¼ˆè¿™æ˜¯å› ä¸ºæ’é™¤äº†MSBï¼Œoffsetæœ€å¤§å€¼ä¸º2^31-1ï¼Œ å› æ­¤å¤§äº2Gçš„æ–‡ä»¶ï¼Œ åˆ™éœ€è¦ä½¿ç”¨large offsetsï¼‰</p>
</li>
<li>
<p>æ¯ä¸ªlarge offsetå­˜å‚¨å ç”¨8 bytesã€‚</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_3_1_7_trailer">3.1.7 TRAILER</h4>
<div class="ulist">
<ul>
<li>
<p>packæ–‡ä»¶çš„checksumï¼Œ å 20 bytes</p>
</li>
<li>
<p>indexæ–‡ä»¶çš„checksumï¼Œå 20bytesã€‚</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ç»“åˆpackæ–‡ä»¶å’Œindexæ–‡ä»¶çš„ä¸€ä¸ªå®é™…çš„æ —å­">ç»“åˆpackæ–‡ä»¶å’Œindexæ–‡ä»¶çš„ä¸€ä¸ªå®é™…çš„æ —å­ğŸŒ°</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å«3ä¸ªå¯¹è±¡çš„packæ–‡ä»¶">é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å«3ä¸ªå¯¹è±¡çš„packæ–‡ä»¶</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">---
[tenglong.tl@code-infra-dev-cbj.ea134 /home/tenglong.tl/test/pack-test.git/.git/objects/pack]
$git verify-pack --verbose  pack-bbe47ea26bb124a49bbb93aaebf067c7971843c4.pack
30cc51a63a6b2726d32abab23e1877a72868edea commit 173 123 12
d00491fd7e5bb6fa28c517a0bb32b8b506539d4d blob   2 11 135
38fd29697b220f7e4ca15b044c3222eefe5afdc1 tree   33 44 146
non delta: 3 objects
pack-bbe47ea26bb124a49bbb93aaebf067c7971843c4.pack: ok
---</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_verify_pack_verbose_å‘½ä»¤ä»‹ç»">&#34;git verify-pack --verbose&#34; å‘½ä»¤ä»‹ç»</h3>
<div class="paragraph">
<p>æˆ‘ä»¬ä½¿ç”¨`git verify-pack --verbose`å¯ä»¥æŸ¥çœ‹packæ–‡ä»¶ä¸­å¯¹è±¡çš„åç§°ã€ç±»å‹å’Œåç§»é‡ç­‰ä¿¡æ¯ï¼Œè¿™å°†å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬å»debug packfileã€‚</p>
</div>
<div class="paragraph">
<p>å¯ä»¥çœ‹åˆ°packæ–‡ä»¶ä¸­æœ‰3ä¸ªå¯¹è±¡ï¼Œ åˆ†åˆ«ä¸ºcommitã€blobå’Œtreeï¼Œ å…¶è¾“å‡ºå†…å®¹çš„formatå¦‚ä¸‹ï¼š</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>&lt;objectname&gt; &lt;objecttype&gt; &lt;objectsize&gt; &lt;objectsize_in_packfile&gt; &lt;objectoffset&gt;</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>å¯¹deltaå¯¹è±¡ è¾“å‡ºçš„formatç•¥æœ‰ä¸åŒ:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>&lt;objectname&gt; &lt;objecttype&gt; &lt;objectsize&gt; &lt;objectsize_in_packfile&gt; &lt;objectoffset&gt; &lt;delta-chain-length&gt; &lt;base_objectname&gt;</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>æˆ‘ä»¬å½“å‰æ²¡æœ‰deltaï¼Œæ‰€ä»¥ä¾‹å­ä¸­å‡ä¸ºç¬¬ä¸€ç§formatè¡¨ç¤º</code>ï¼Œ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŒ…`pack-bbe47ea26bb124a49bbb93aaebf067c7971843c4.pack`ä¸­</p>
</div>
</div>
<div class="sect2">
<h3 id="_ä½¿ç”¨hexdumpå‘½ä»¤æŸ¥çœ‹packæ–‡ä»¶">ä½¿ç”¨hexdumpå‘½ä»¤æŸ¥çœ‹packæ–‡ä»¶</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">---
$cat pack-bbe47ea26bb124a49bbb93aaebf067c7971843c4.pack | hexdump -C
00000000  50 41 43 4b 00 00 00 02  00 00 00 03 9d 0a 78 9c  |PACK..........x.|
00000010  9d cb 3d 0a c3 30 0c 40  e1 dd a7 d0 5e 28 b2 ac  |..=..0.@....^(..|
00000020  fc 18 4a e9 01 32 f6 02  8e 2d a7 81 3a 06 a3 0e  |..J..2...-..:...|
00000030  bd 7d 3c f4 04 5d de f0  c1 d3 26 02 6e ce 89 fc  |.}&lt;..]....&amp;.n...|
00000040  e8 a7 95 08 f3 24 1c 83  1d 56 64 8e 8e 88 44 b2  |.....$...Vd...D.|
00000050  0c 21 a7 68 4d f8 e8 ab  36 78 ca b1 c1 52 7b 6e  |.!.hM...6x...R{n|
00000060  e9 db ea 21 da e1 b1 95  b0 bf af b1 96 3b d8 91  |...!.........;..|
00000070  d9 7b 76 ec e1 82 33 a2  e9 5a 76 55 f9 e7 fd cd  |.{v...3..ZvU....|
00000080  60 cd 09 4a b0 34 fb 32  78 9c 33 e4 02 00 00 6e  |`..J.4.2x.3....n|
00000090  00 3c a1 02 78 9c 33 34  30 30 33 31 51 30 d4 2b  |.&lt;..x.340031Q0.+|
000000a0  a9 28 61 b8 c0 32 f1 6f  5d f4 b6 5f 1a 47 c5 17  |.(a..2.o].._.G..|
000000b0  ec 36 da b1 95 2d 78 ae  2f 00 c2 8c 0d 3b bb e4  |.6...-x./....;..|
000000c0  7e a2 6b b1 24 a4 9b bb  93 aa eb f0 67 c7 97 18  |~.k.$.......g...|
000000d0  43 c4                                             |C.|
000000d2
---</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ç»“åˆgit_verify_pack_verbose_åˆ†æ_packæ–‡ä»¶">ç»“åˆ`git verify-pack --verbose` åˆ†æ packæ–‡ä»¶</h3>
<div class="paragraph">
<p>å› ä¸ºpackä¸­é¦–å…ˆå­˜å‚¨çš„æ˜¯12 bytesçš„æ–‡ä»¶å¤´ï¼Œ æ‰€ä»¥å¯¹äºpackä¸­ç¬¬ä¸€ä¸ªå¯¹è±¡çš„offsetï¼Œ å…¶å®æ˜¯å›ºå®šä¸º <code>12(0x0c)</code>.</p>
</div>
<div class="paragraph">
<p>æ•… æˆ‘ä»¬ä»offsetçš„ç¬¬12ä¸ªä½ç½®å¼€å§‹è¯»èµ·ï¼Œ æ ¼å¼ä¸º&lt;size-data-encoding&gt;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>9d: [1] [001] [1101]</code>  ä¸ºç¬¬ä¸€ä¸ª size encoding byte, typeä¸º001(commit) , å¹¶ä¸”msb = 1 â‡’ continueè¯»åŒºä¸‹ä¸€ä¸ª byte, tail sizeä¸º <code>1101</code></p>
</li>
<li>
<p><code>0a: [0] [000] [1010]</code> ä¸ºç¬¬äºŒä¸ªsize encoding byteï¼Œ msb =0 â‡’ stop, head size = 00001010 &lt;&lt; 4 = 10100000</p>
</li>
<li>
<p>æ•… <code>object size</code> = (10100000 | 1101) = 10101101 = <code>173(digit)</code>, æ³¨æ„æ­¤å¤§å°ä¸ºå¯¹è±¡è§£å‹åçš„å¤§å°è€Œéåœ¨packä¸­å­˜å‚¨çš„å¤§å°</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ä»¥æ­¤ç±»æ¨ï¼Œ123bytesä¹‹åä¸ºç¬¬äºŒä¸ªå¯¹è±¡ ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>32: [0] [011] [0010]</code> , msb =0, type 011(blob), å› ä¸ºmsb = 0 â‡’ stop size = 0010 , size ä¸º 2</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>æœ€åindex+packçš„å­˜å‚¨å’Œç´¢å¼•æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../images/index-pack.png" alt="Packfile Format" width="512" height="512"/></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_æœ€å">æœ€å</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ä½†æ˜¯å†™ç€å†™ç€ï¼Œ è¿™éƒ¨åˆ†å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œ ç›®å‰å…ˆå†™åˆ°è¿™é‡Œï¼Œåç»­è¯¥æ–‡æ¡£åº”è¯¥ä¼šå¤§æ¦‚ç‡æ›´æ–°ï¼ˆè¡¥å……indexéƒ¨åˆ†çš„æ–‡ä»¶å†…å®¹åˆ†æï¼‰ï¼Œéšåæ˜¯å¤šåŒ…ç´¢å¼•ä¹‹ç±»çš„å†…å®¹æ”¾åˆ°å¦å¤–ä¸€ç¯‡blogä¸­ã€‚</p>
</div>
<div class="paragraph">
<p>å¦‚æœæœ‰ä¸€äº›æ–‡å­—é”™è¯¯æˆ–è€…æŠ€æœ¯æ€§é”™è¯¯ï¼Œ æ¬¢è¿æŒ‡å‡ºã€‚</p>
</div>
</div>
</div>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/git/" rel="tag">git</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/chinese/" rel="tag">chinese</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/introduce/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Introduce</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/acceptance_test/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Why Acceptance Testing is so important to us(Chinese)?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 dyrone.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>